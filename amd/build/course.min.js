/**
 * Main Javascript module for format_tiles for when user is *NOT* editing.
 * See course_edit for if they are editing.
 * Handles the UI changes when tiles are selected and anything else not
 * covered by the specific modules
 *
 * @module      format_tiles/course
 * @package     course/format
 * @subpackage  tiles
 * @copyright   2018 David Watson {@link http://evolutioncode.uk}
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("format_tiles/course",["jquery","core/templates","core/ajax","format_tiles/browser_storage","core/notification","core/str","format_tiles/tile_fitter"],(function($,Templates,ajax,browserStorage,Notification,str,tileFitter){var isMobile,loadingIconHtml,windowOverlay,courseId,enableCompletion,body=$("body"),bodyHtml=$("body, html"),stringStore=[],scrollFuncLock=!1,sectionIsOpen=!1,reopenLastVisitedSection=!1,backDropZIndex=0,resizeLocked=!1,openTile=0,Selector={PAGE:"#page",TILE:".tile",TILEID:"#tile-",MOVEABLE_SECTION:".moveablesection",FILTER_BUTTON:".filterbutton",TILE_LOADING_ICON:".tile-loading-icon",TILE_LOADING_ICON_ID:"#loading-icon-",TILE_COLLAPSED:".tile-collapsed",TILE_CLICKABLE:".tile-clickable",TILES:"ul.tiles",ACTIVITY:".activity",SPACER:".spacer",SECTION_MOVEABLE:".moveablesection",SECTION_ID:"#section-",SECTION_TITLE:".sectiontitle",SECTION_MAIN:".section.main",SECTION_BUTTONS:".sectionbuttons",CLOSE_SEC_BTN:".closesectionbtn",HIDE_SEC0_BTN:"#buttonhidesec0",SECTION_ZERO:"#section-0",MOODLE_VIDEO:".mediaplugin.mediaplugin_videojs",LAUNCH_STANDARD:'[data-action="launch-tiles-standard"]',TOOLTIP:"[data-toggle=tooltip]",HEADER_BAR:["header.navbar","nav.fixed-top.navbar","#essentialnavbar.moodle-has-zindex","#navwrap","nav.navbar-fixed-top","#adaptable-page-header-wrapper"]},ClassNames_SELECTED="selected",ClassNames_OPEN="open",ClassNames_CLOSED="closed",ClassNames_STATE_VISIBLE="state-visible",Event_CLICK="click",Event_KEYDOWN="keydown",Event_SCROLL="scroll",CSS_DISPLAY="display",CSS_Z_INDEX="z-index",CSS_BG_COLOUR="background-color",Keyboard_ESCAPE=27,Keyboard_TAB=9,Keyboard_RETURN=13,stopVideoPlaying=function(section){var contentSection=$(Selector.SECTION_ID+section);contentSection.find("iframe").each((function(index,iframe){(iframe=$(iframe)).attr("src")&&(iframe.attr("data-src",iframe.attr("src")),iframe.attr("src",""))})),contentSection.find(Selector.MOODLE_VIDEO).length>0&&contentSection.html("")},cancelTileSelections=function(sectionToFocus){$(Selector.MOVEABLE_SECTION).each((function(index,sec){(sec=$(sec)).is(":visible")&&(stopVideoPlaying(sec.attr("data-section")),sec.slideUp().removeClass(ClassNames_STATE_VISIBLE))})),$(Selector.TILE).removeClass(ClassNames_SELECTED).css(CSS_Z_INDEX,"").css(CSS_BG_COLOUR,""),$(".section "+ClassNames_SELECTED).removeClass(ClassNames_SELECTED).css(CSS_Z_INDEX,""),windowOverlay.fadeOut(300),void 0!==sectionToFocus&&0!==sectionToFocus&&$(Selector.TILEID+sectionToFocus).focus(),$(Selector.TILE_LOADING_ICON).fadeOut(300,(function(){$(Selector.TILE_LOADING_ICON).html("")})),sectionIsOpen=!1,openTile=0},setCourseContentHTML=function(contentArea,content){if(content){if(contentArea.html(content),$(Selector.TILE_LOADING_ICON).fadeOut(300,(function(){$(Selector.TILE_LOADING_ICON).html("")})),contentArea.attr("id")!==Selector.SECTION_ZERO){var activities=contentArea.find(Selector.ACTIVITY).not(Selector.SPACER);contentArea.on(Event_KEYDOWN,(function(e){e.keyCode===Keyboard_ESCAPE&&(browserStorage.setLastVisitedSection(0),cancelTileSelections(0),$(Selector.TILEID+contentArea.attr("data-section")).focus())})),isMobile||(activities.last().on(Event_KEYDOWN,(function(e){e.keyCode!==Keyboard_TAB||e.shiftKey||$(e.relatedTarget).closest(Selector.SECTION_MAIN).attr("id")===contentArea.attr("id")||setTimeout((function(){contentArea.find(Selector.SECTION_TITLE).focus(),bodyHtml.animate({scrollTop:contentArea.offset().top-60},"slow"),contentArea.find(Selector.SECTION_BUTTONS).css("top","")}),200)})),contentArea.find(Selector.SECTION_TITLE).on(Event_KEYDOWN,(function(e){e.keyCode===Keyboard_TAB&&e.shiftKey&&$(e.relatedTarget).closest(Selector.SECTION_MAIN).attr("id")!==contentArea.attr("id")&&setTimeout((function(){activities.last().focus()}),200)})))}if(isMobile||setTimeout((function(){try{var tooltipItems=contentArea.find(".badge-info");tooltipItems.length>0&&"function"==typeof tooltipItems.tooltip&&tooltipItems.tooltip()}catch(err){require(["core/log"],(function(log){log.debug(err)}))}}),500),0!==contentArea.find(Selector.MOODLE_VIDEO).length&&require(["media_videojs/loader"],(function(videoJS){videoJS.setUp()})),void 0!==window.MathJax)try{var mathJaxElems=contentArea.find(".filter_mathjaxloader_equation");mathJaxElems.length&&mathJaxElems.each((function(i,node){window.MathJax.Hub.Queue(["Typeset",window.MathJax.Hub,node])}))}catch(err){require(["core/log"],(function(log){log.debug(err)}))}return!0}return!1},expandSection=function(contentArea,tileId){contentArea.addClass(ClassNames_STATE_VISIBLE),contentArea.slideDown(350,(function(){var buttons;!function(){var scrollTo=$("#tileText-"+tileId).offset().top-60;scrollTo===$(window).scrollTop&&(scrollTo+=1),contentArea.find(Selector.SECTION_TITLE).focus();var events="scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove";body.on(events,(function(){body.stop()})),bodyHtml.animate({scrollTop:scrollTo},"slow",(function(){bodyHtml.off(events,(function(){bodyHtml.stop()}))})),sectionIsOpen=!0,openTile=tileId,contentArea.find("a").first().focus();var iframes=contentArea.find("iframe");iframes.length>0&&(iframes.each((function(index,iframe){""===(iframe=$(iframe)).attr("src")&&void 0!==iframe.attr("data-src")&&iframe.attr("src",iframe.attr("data-src"))})),enableCompletion&&require(["format_tiles/completion"],(function(completion){setTimeout((function(){completion.updateTileInformation()}),1e3)})))}(),buttons=contentArea.find(Selector.SECTION_BUTTONS),$(window).on(Event_SCROLL,(function(){!scrollFuncLock&&sectionIsOpen&&(scrollFuncLock=!0,buttons.fadeOut(300),setTimeout((function(){var windowTop=$(window).scrollTop(),desiredNewPositionInSection=windowTop-contentArea.offset().top+50;desiredNewPositionInSection>0&&desiredNewPositionInSection<contentArea.outerHeight()-100?(desiredNewPositionInSection=windowTop-contentArea.offset().top+50,buttons.css("top",desiredNewPositionInSection),"none"===windowOverlay.css(CSS_DISPLAY)&&windowOverlay.fadeIn(300)):desiredNewPositionInSection<0&&buttons.css("top",0),windowTop>contentArea.offset().top+contentArea.outerHeight()-50||contentArea.offset().top>windowTop+$(window).outerHeight()?("block"===windowOverlay.css(CSS_DISPLAY)&&windowOverlay.fadeOut(300),buttons.css("top",0)):"none"===windowOverlay.css(CSS_DISPLAY)&&windowOverlay.fadeIn(300),buttons.fadeIn(300,(function(){scrollFuncLock=!1}))}),500))})),scrollFuncLock||sectionIsOpen||!windowOverlay.is(":visible")||windowOverlay.fadeOut(300)})),openTile=tileId},reOrgSections=function(delayBefore,fitTilesToScreenWidth){var dfd=new $.Deferred,openedSection=$(".moveablesection:visible"),openedSectionNum=0;openedSection.length>0&&(openedSectionNum=openedSection.attr("data-section"),cancelTileSelections());var reOrgFunc=function(delayBefore){tileFitter.runReOrg(delayBefore).done((function(result){0!==openedSectionNum&&expandSection(openedSection,openedSectionNum),dfd.resolve(result)})).fail((function(result){0!==openedSectionNum&&expandSection(openedSection,openedSectionNum),dfd.reject(result)}))};return fitTilesToScreenWidth?setTimeout((function(){tileFitter.resizeTilesDivWidth(courseId).done((function(){reOrgFunc(!1)}),delayBefore)})):reOrgFunc(delayBefore),dfd.promise()},getSectionContentFromServer=function(courseId,sectionNum){return ajax.call([{methodname:"format_tiles_get_single_section_page_html",args:{courseid:courseId,sectionid:sectionNum,setjsusedsession:!0}}])[0]},setOverlay=function(secNumOnTop){windowOverlay.fadeIn(300),backDropZIndex=parseInt(windowOverlay.css(CSS_Z_INDEX));var R,G,B,percent,t,p,tile=$(Selector.TILEID+secNumOnTop);if(tile.css(CSS_Z_INDEX,backDropZIndex+1),$(Selector.SECTION_ID+secNumOnTop).css(CSS_Z_INDEX,backDropZIndex+1),tile.css(CSS_BG_COLOUR)&&"rgba"===tile.css(CSS_BG_COLOUR).substr(0,4)){var existingColour=tile.css(CSS_BG_COLOUR).replace("rgba(","").replace(")","").replace(" ","").split(",");tile.css(CSS_BG_COLOUR,(R=parseInt(existingColour[0]),G=parseInt(existingColour[1]),B=parseInt(existingColour[2]),t=(percent=.95)<0?0:255,p=percent<0?-1*percent:percent,"rgb("+(Math.round((t-R)*p)+R)+","+(Math.round((t-G)*p)+G)+","+(Math.round((t-B)*p)+B)+")"))}},populateAndExpandSection=function(courseId,thisTile,dataSection){setOverlay(dataSection),$(Selector.TILE).removeClass(ClassNames_SELECTED),thisTile.addClass(ClassNames_SELECTED),openTile=dataSection,$(Selector.MOVEABLE_SECTION).each((function(index,sec){(sec=$(sec)).is(":visible")&&(stopVideoPlaying(sec.attr("data-section")),sec.slideUp(200).removeClass(ClassNames_STATE_VISIBLE))})),ajax.call([{methodname:"format_tiles_log_tile_click",args:{courseid:courseId,sectionid:dataSection}}])[0].fail(Notification.exception);var relatedContentArea=$(Selector.SECTION_ID+dataSection);relatedContentArea.find(Selector.ACTIVITY).length>0?(expandSection(relatedContentArea,dataSection),getSectionContentFromServer(courseId,dataSection).done((function(response){setCourseContentHTML(relatedContentArea,$(response.html).html())}))):(relatedContentArea.html(loadingIconHtml),getSectionContentFromServer(courseId,dataSection).done((function(response){setCourseContentHTML(relatedContentArea,$(response.html).html()),expandSection(relatedContentArea,dataSection)})).fail((function(failResult){!function(sectionNum,failResult,contentArea){throw failResult?(Notification.confirm(stringStore.sectionerrortitle,stringStore.sectionerrorstring,stringStore.refresh,stringStore.cancel,(function(){window.location.reload()}),null),contentArea.html("")):(setCourseContentHTML(contentArea,"<p>"+stringStore.noconnectionerror+"</p>"),setTimeout((function(){expandSection(contentArea,sectionNum)}),500)),require(["core/log"],(function(log){log.debug(failResult)})),new Error("Not successful retrieving tile content by AJAX for section "+sectionNum)}(dataSection,failResult,relatedContentArea),cancelTileSelections(dataSection)}))),browserStorage.setLastVisitedSection(dataSection)};return{init:function(courseIdInit,useJavascriptNav,isMobileInit,sectionNum,useFilterButtons,assumeDataStoreConsent,reopenLastSectionInit,userId,fitTilesToWidth,usingH5pFilter,enableCompletionInit){courseId=courseIdInit,isMobile=isMobileInit,reopenLastVisitedSection="1"===reopenLastSectionInit,useFilterButtons=1===useFilterButtons,assumeDataStoreConsent="1"===assumeDataStoreConsent,enableCompletion="1"===enableCompletionInit,browserStorage.init(courseId,!1,sectionNum,assumeDataStoreConsent,userId),$(document).ready((function(){var pageContent=$("#page-content");0===pageContent.length&&(pageContent=$("#region-main")),0!==sectionNum?openTile=sectionNum:reopenLastVisitedSection&&browserStorage.storageEnabledLocal&&(openTile=browserStorage.getLastVisitedSection()),0!==openTile?tileFitter.init(courseId,openTile,fitTilesToWidth,!1):($(Selector.TILEID+"1").focus(),tileFitter.init(courseId,null,fitTilesToWidth,!1));var buttonHideSecZero,sectionZero,windowWidth=$(window).outerWidth();if(useJavascriptNav){(windowOverlay=$("<div></div>").addClass("modal-backdrop fade in").hide().attr("id","window-overlay").appendTo(body)).click((function(e){cancelTileSelections(0),function(e){var clickedItem=$(e.currentTarget);if("window-overlay"===clickedItem.attr("id")){clickedItem.hide();var BottomElement=$(document.elementFromPoint(e.clientX,e.clientY));if(clickedItem.show(),"window-overlay"===clickedItem.attr("id"))if(BottomElement.hasClass("filterbutton")||BottomElement.hasClass("list-group-item"))BottomElement.click();else{var clickedTile=BottomElement.closest(Selector.TILE);clickedTile&&clickedTile.click()}else cancelTileSelections(0),BottomElement.click()}}(e)})),pageContent.on(Event_CLICK,Selector.TILE_CLICKABLE,(function(e){if(useJavascriptNav){e.preventDefault(),$(window).off(Event_SCROLL),$(Selector.TILE_LOADING_ICON).fadeOut(300,(function(){$(Selector.TILE_LOADING_ICON).html()}));var thisTile=$(e.currentTarget).closest(Selector.TILE),dataSection=parseInt(thisTile.attr("data-section"));thisTile.hasClass(ClassNames_SELECTED)?(cancelTileSelections(dataSection),browserStorage.setLastVisitedSection(0)):populateAndExpandSection(courseId,thisTile,dataSection);var nextSecIfExists=$(Selector.SECTION_ID+(dataSection+1));!isMobile&&!usingH5pFilter&&nextSecIfExists.length&&dataSection>0&&getSectionContentFromServer(courseId,dataSection+1).done((function(response){setCourseContentHTML(nextSecIfExists,$(response.html).html())}))}})),$(window).on("resize",(function(){resizeLocked||windowWidth===$(window).outerWidth()||(resizeLocked=!0,setTimeout((function(){var resizeRequired=!0,openContentSection=$(".moveablesection:visible");if(0!==openContentSection.length){var mediaPlayers=openContentSection.find(".mediaplugin iframe");0!==mediaPlayers.length&&mediaPlayers.each((function(index,player){(player=$(player)).outerWidth()>openContentSection.outerWidth()&&(resizeRequired=!1)}))}resizeRequired&&(windowWidth=$(window).outerWidth(),reOrgSections(!0,fitTilesToWidth)),resizeLocked=!1}),600))}));var overlayZindex=parseInt(windowOverlay.css(CSS_Z_INDEX)),headerBar=$(Selector.HEADER_BAR.find((function(selector){return $(selector).length>0})));void 0!==headerBar&&0!==headerBar.length&&headerBar.css(CSS_Z_INDEX,overlayZindex+3),pageContent.on(Event_CLICK,Selector.CLOSE_SEC_BTN,(function(e){cancelTileSelections($(e.currentTarget).attr("data-section"))})),pageContent.on(Event_CLICK,Selector.LAUNCH_STANDARD,(function(e){var clickedLk=$(e.currentTarget);void 0!==clickedLk.attr("href")?window.location=clickedLk.attr("href"):void 0!==clickedLk.find("a").attr("href")&&(window.location=clickedLk.find("a").attr("href"))})),buttonHideSecZero=$(Selector.HIDE_SEC0_BTN),sectionZero=$(Selector.SECTION_ZERO),browserStorage.storageEnabledLocal()?!0===browserStorage.getSecZeroCollapseStatus()?(sectionZero.slideUp(0),buttonHideSecZero.addClass(ClassNames_CLOSED).removeClass(ClassNames_OPEN)):(sectionZero.slideDown(300),buttonHideSecZero.addClass(ClassNames_OPEN).removeClass(ClassNames_CLOSED)):(buttonHideSecZero.addClass(ClassNames_OPEN).removeClass(ClassNames_CLOSED),sectionZero.slideDown(300))}$(document).on("format-tiles-completion-changed",(function(e,data){var allSectionNums=$(Selector.TILE).not(Selector.SPACER).map((function(i,t){return parseInt($(t).attr("data-section"))})).toArray();allSectionNums.push(0);var requests=ajax.call([{methodname:"format_tiles_get_single_section_page_html",args:{courseid:courseId,sectionid:data.section,setjsusedsession:!0}},{methodname:"format_tiles_get_section_information",args:{courseid:courseId,sectionnums:allSectionNums}}]);requests[0].done((function(response){setCourseContentHTML($(Selector.SECTION_ID+data.section),$(response.html).html())})).catch((function(err){require(["core/log"],(function(log){log.debug(err)}))})),requests[1].done((function(response){require(["format_tiles/completion"],(function(completion){completion.updateSectionsInfo(response.sections,response.overall.complete,response.overall.outof)}))})).catch((function(err){require(["core/log"],(function(log){log.debug(err)}))}))})),pageContent.on(Event_CLICK,Selector.HIDE_SEC0_BTN,(function(e){var sectionZero=$(Selector.SECTION_ZERO);"none"===sectionZero.css(CSS_DISPLAY)?(sectionZero.slideDown(250),$(e.currentTarget).addClass(ClassNames_OPEN).removeClass(ClassNames_CLOSED),browserStorage.setSecZeroCollapseStatus("collapsed")):(sectionZero.slideUp(250),$(e.currentTarget).addClass(ClassNames_CLOSED).removeClass(ClassNames_OPEN),browserStorage.setSecZeroCollapseStatus("expanded"))})),useFilterButtons&&(require(["format_tiles/filter_buttons"],(function(filterButtons){filterButtons.init(courseId,browserStorage.storageEnabledLocal)})),useJavascriptNav&&pageContent.on(Event_CLICK,Selector.FILTER_BUTTON,(function(){cancelTileSelections(0),reOrgSections(!0,!1)}))),$(".tiles_coursenav").removeClass("hidden"),Templates.render("format_tiles/loading",{}).done((function(html){loadingIconHtml=html}));var stringKeys=[{key:"sectionerrortitle",component:"format_tiles"},{key:"sectionerrorstring",component:"format_tiles"},{key:"refresh"},{key:"cancel"},{key:"noconnectionerror",component:"format_tiles"},{key:"show"},{key:"hide"},{key:"other",component:"format_tiles"},{key:"blockedpopuptitle",component:"format_tiles"}];str.get_strings(stringKeys).done((function(s){s.forEach((function(str,index){str?stringStore[stringKeys[index].key]=str:(stringStore[stringKeys[index].key]="Error.",require(["core/log"],(function(log){log.debug("Format tiles get_strings error ".concat(index)),log.debug(s)})))}))})).fail((function(err){require(["core/log"],(function(log){log.debug(err)}))})),isMobile?pageContent.on(Event_CLICK,Selector.ACTIVITY+".video a",(function(e){var target=$(e.currentTarget),url=target.closest(Selector.ACTIVITY).attr("data-url-secondary");if(void 0!==url){e.preventDefault(),e.stopPropagation();var cm=target.closest(Selector.ACTIVITY);ajax.call([{methodname:"format_tiles_log_mod_view",args:{courseid:courseId,cmid:cm.attr("data-cmid")}}])[0].done((function(){require(["format_tiles/completion"],(function(completion){completion.markAsAutoCompleteInUI(courseId,cm)}))})),window.location=url}})):$(Selector.TILE).on(Event_KEYDOWN,(function(e){e.keyCode===Keyboard_RETURN&&$(e.currentTarget).click()})),$(document).on("filter-content-updated",(function(event,msg){if(msg.length>0){var elem=$(msg[0]);elem.hasClass("moodle-dialogue")&&elem.css("z-index")<backDropZIndex&&elem.css("z-index",backDropZIndex+1)}}))}))}}}));

//# sourceMappingURL=course.min.js.map